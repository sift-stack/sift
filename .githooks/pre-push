#!/usr/bin/env bash

# Store the root directory of the repository
REPO_ROOT="$(git rev-parse --show-toplevel)"
GITHOOKS_DIR="$REPO_ROOT/.githooks"

# Track failures
FAILED=0

echo "========================================"
echo "  Pre-Push Checks"
echo "========================================"
echo

# Check for changes in Python files
# Compare against the remote branch being pushed to
python_changed_files=($(git diff --name-only --diff-filter=ACM @{upstream}... | grep -E '^(python/|pyproject.toml)' || true))
echo "→ Python files changed:"
if [[ -n "$python_changed_files" ]]; then
    echo "  ${python_changed_files[*]}"
    echo
    echo "  [1/3] Formatting and linting..."
    bash "$GITHOOKS_DIR/pre-push-python/fmt-lint.sh" || FAILED=1
    
    echo "  [2/3] Stub generation..."
    bash "$GITHOOKS_DIR/pre-push-python/stubs.sh" || FAILED=1
    
    echo "  [3/3] Extras validation..."
    bash "$GITHOOKS_DIR/pre-push-python/extras.sh" || FAILED=1
    echo
else
    echo "  (none)"
    echo
fi

# Check for changes in Rust bindings files
bindings_changed_files=($(git diff --name-only --diff-filter=ACM @{upstream}... | grep '^rust/crates/sift_stream_bindings/src/' || true))

echo "→ Rust binding files changed:"
if [[ -n "$bindings_changed_files" ]]; then
    echo "  ${bindings_changed_files[*]}"
    echo
    echo "  [1/1] Stub generation..."
    bash "$GITHOOKS_DIR/pre-push-rust/stubs.sh" || FAILED=1
    echo
else
    echo "  (none)"
    echo
fi

if [[ $FAILED -eq 1 ]]; then
    echo "========================================"
    echo "  ✗ Some checks failed"
    echo "========================================"
    exit 1
else
    echo "========================================"
    echo "  ✓ All checks passed"
    echo "========================================"
fi

