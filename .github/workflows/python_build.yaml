name: Offline Installation Archive

on:
  workflow_dispatch:
  pull_request:

jobs:
  get-python-versions:
    runs-on: ubuntu-latest
    outputs:
      python-versions: ${{ steps.get-versions.outputs.versions }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Get Python versions from pyproject.toml
        id: get-versions
        run: |
          versions=$(grep "Programming Language :: Python :: " python/pyproject.toml | sed 's/.*Python :: \([0-9.]*\).*/\1/' | jq -R -s -c 'split("\n")[:-1]')
          echo "versions=$versions" >> $GITHUB_OUTPUT

  build_and_verify:
    name: Build and verify on ${{ matrix.config.os }} (${{ matrix.config.arch }}) with Python ${{ matrix.python-version }}
    needs: get-python-versions
    runs-on: ${{ matrix.config.runner }}
    env:
      DIST_PLATFORM: ${{ matrix.config.os == 'windows' && format('win_{0}', matrix.config.arch) || format('{0}-{1}', matrix.config.os, matrix.config.arch) }}
    strategy:
      fail-fast: false  # Continue with other builds even if one fails
      matrix:
        config:
          # Ubuntu builds (x86_64 and aarch64)
          - os: ubuntu
            arch: x86_64
            runner: ubuntu-latest
          - os: ubuntu
            arch: aarch64
            runner: ubuntu-latest
            
          # macOS builds (x86_64 and arm64)
          - os: macos
            arch: x86_64
            runner: macos-latest
          - os: macos
            arch: arm64
            runner: macos-14
            
          # Windows builds (x64)
          - os: windows
            arch: amd64
            runner: windows-latest
        python-version: ${{fromJson(needs.get-python-versions.outputs.python-versions)}}

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        if: matrix.config.arch == 'aarch64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install build tools
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install build pip-tools twine

      - name: Generate requirements
        working-directory: python
        shell: bash
        run: |
          # Generate requirements file with only openssl extras
          # npTDMS doesn't have wheels for all platforms, 
          # so we need to build it from source which was causing issues on windows
          pip-compile pyproject.toml --extra=openssl -o requirements-all.txt

      - name: Download dependencies
        working-directory: python
        shell: bash
        run: |
          mkdir -p dist/deps
          # First download build dependencies
          pip download -d dist/deps \
            setuptools wheel Cython \
            --prefer-binary \
            --no-deps

          # Then download package dependencies
          pip download -r requirements-all.txt -d dist/deps \
            --python-version ${{ matrix.python-version }} \
            --prefer-binary \
            --no-deps

      - name: Build sift-py wheel
        working-directory: python
        shell: bash
        run: |
          python -m build --wheel

      - name: Verify wheel
        working-directory: python
        shell: bash
        run: |
          twine check dist/*.whl

      - name: Test installations
        working-directory: python
        shell: bash
        run: |
          # Get the wheel file name
          WHEEL_FILE=$(ls dist/*.whl)
          
          # Test base installation
          python -m venv test_venv_base
          if [ "${{ matrix.config.os }}" = "windows" ]; then
            source test_venv_base/Scripts/activate
          else
            source test_venv_base/bin/activate
          fi
          pip install --no-index --find-links=dist/deps "$WHEEL_FILE"
          deactivate
          rm -rf test_venv_base

          # Test openssl installation
          python -m venv test_venv_openssl
          if [ "${{ matrix.config.os }}" = "windows" ]; then
            source test_venv_openssl/Scripts/activate
          else
            source test_venv_openssl/bin/activate
          fi
          pip install --no-index --find-links=dist/deps "$WHEEL_FILE[openssl]"
          deactivate
          rm -rf test_venv_openssl

      - name: Create distribution archive
        working-directory: python
        shell: bash
        run: |
          python -c "import shutil; shutil.make_archive('dist/sift-py-dist-${{ env.DIST_PLATFORM }}-py${{ matrix.python-version }}', 'zip', 'dist')"

      - name: Upload distribution archive
        uses: actions/upload-artifact@v4
        with:
          name: sift-py-dist-${{ env.DIST_PLATFORM }}-py${{ matrix.python-version }}
          path: python/dist/sift-py-dist-*.zip
          retention-days: 7

  merge_platform_archives:
    name: Merge platform archives
    needs: [build_and_verify]
    runs-on: ubuntu-latest
    steps:
      - name: Download all archives
        uses: actions/download-artifact@v4
        with:
          pattern: sift-py-dist-*-py*
          path: platform_archives
          merge-multiple: false

      - name: Merge archives by platform
        shell: bash
        run: |
          # Function to merge archives for a platform
          merge_platform_archives() {
            local platform=$1
            echo "Merging archives for platform: $platform"
            
            # Create directory for merged wheels
            mkdir -p "merged_$platform/dist/deps"
            
            # Extract all archives and merge unique wheels
            for zip in platform_archives/*/sift-py-dist-$platform-py*.zip; do
              unzip -o "$zip" -d "temp_extract"
              # Copy all wheels, letting newer ones overwrite older ones
              cp -r temp_extract/dist/* "merged_$platform/dist/"
              rm -rf temp_extract
            done
            
            # Create merged archive
            cd "merged_$platform"
            zip -r "../sift-py-dist-$platform-all-python.zip" dist/
            cd ..
          }

          # Merge archives for each platform
          merge_platform_archives "ubuntu-x86_64"
          merge_platform_archives "ubuntu-aarch64"
          merge_platform_archives "macos-x86_64"
          merge_platform_archives "macos-arm64"
          merge_platform_archives "win_amd64"

      - name: Upload merged archives
        uses: actions/upload-artifact@v4
        with:
          name: sift-py-dist-all-platforms
          path: sift-py-dist-*-all-python.zip
          retention-days: 7
