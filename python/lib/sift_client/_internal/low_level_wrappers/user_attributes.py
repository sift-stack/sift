from __future__ import annotations

import logging
from typing import TYPE_CHECKING, Any, cast

from sift.user_attributes.v1.user_attributes_pb2 import (
    ArchiveUserAttributeKeysRequest,
    ArchiveUserAttributeValuesRequest,
    BatchCreateUserAttributeValueRequest,
    BatchCreateUserAttributeValueResponse,
    CreateUserAttributeKeyRequest,
    CreateUserAttributeKeyResponse,
    CreateUserAttributeValueRequest,
    CreateUserAttributeValueResponse,
    GetUserAttributeKeyRequest,
    GetUserAttributeKeyResponse,
    GetUserAttributeValueRequest,
    GetUserAttributeValueResponse,
    ListUserAttributeKeysRequest,
    ListUserAttributeKeysResponse,
    ListUserAttributeKeyValuesRequest,
    ListUserAttributeKeyValuesResponse,
    ListUserAttributeValuesRequest,
    ListUserAttributeValuesResponse,
    UnarchiveUserAttributeKeysRequest,
    UnarchiveUserAttributeValuesRequest,
    UpdateUserAttributeKeyRequest,
    UpdateUserAttributeKeyResponse,
)
from sift.user_attributes.v1.user_attributes_pb2_grpc import UserAttributesServiceStub

from sift_client._internal.low_level_wrappers.base import LowLevelClientBase
from sift_client.sift_types.user_attributes import (
    UserAttributeKey,
    UserAttributeKeyUpdate,
    UserAttributeValue,
)
from sift_client.transport import WithGrpcClient

if TYPE_CHECKING:
    from sift_client.transport.grpc_transport import GrpcClient

# Configure logging
logger = logging.getLogger(__name__)


class UserAttributesLowLevelClient(LowLevelClientBase, WithGrpcClient):
    """Low-level client for the UserAttributesService.

    This class provides a thin wrapper around the autogenerated bindings for the UserAttributesService.
    """

    def __init__(self, grpc_client: GrpcClient):
        """Initialize the UserAttributesLowLevelClient.

        Args:
            grpc_client: The gRPC client to use for making API calls.
        """
        super().__init__(grpc_client)

    # User Attribute Key methods

    async def create_user_attribute_key(
        self, name: str, description: str | None, value_type: int
    ) -> UserAttributeKey:
        """Create a new user attribute key.

        Args:
            name: The name of the user attribute key.
            description: Optional description.
            value_type: The UserAttributeValueType enum value.

        Returns:
            The created UserAttributeKey.
        """
        request = CreateUserAttributeKeyRequest(name=name, type=value_type)
        if description is not None:
            request.description = description

        response = await self._grpc_client.get_stub(
            UserAttributesServiceStub
        ).CreateUserAttributeKey(request)
        grpc_key = cast("CreateUserAttributeKeyResponse", response).user_attribute_key
        return UserAttributeKey._from_proto(grpc_key)

    async def get_user_attribute_key(self, key_id: str) -> UserAttributeKey:
        """Get a user attribute key by ID.

        Args:
            key_id: The user attribute key ID.

        Returns:
            The UserAttributeKey.
        """
        request = GetUserAttributeKeyRequest(user_attribute_key_id=key_id)
        response = await self._grpc_client.get_stub(UserAttributesServiceStub).GetUserAttributeKey(
            request
        )
        grpc_key = cast("GetUserAttributeKeyResponse", response).user_attribute_key
        return UserAttributeKey._from_proto(grpc_key)

    async def list_user_attribute_keys(
        self,
        *,
        page_size: int | None = None,
        page_token: str | None = None,
        query_filter: str | None = None,
        order_by: str | None = None,
        organization_id: str | None = None,
        include_archived: bool = False,
    ) -> tuple[list[UserAttributeKey], str]:
        """List user attribute keys with optional filtering and pagination.

        Args:
            page_size: The maximum number of keys to return.
            page_token: A page token for pagination.
            query_filter: A CEL filter string.
            order_by: How to order the retrieved keys.
            organization_id: Optional organization ID filter.
            include_archived: Whether to include archived keys.

        Returns:
            A tuple of (keys, next_page_token).
        """
        request_kwargs: dict[str, Any] = {
            "include_archived": include_archived,
        }
        if page_size is not None:
            request_kwargs["page_size"] = page_size
        if page_token is not None:
            request_kwargs["page_token"] = page_token
        if query_filter is not None:
            request_kwargs["filter"] = query_filter
        if order_by is not None:
            request_kwargs["order_by"] = order_by
        if organization_id is not None:
            request_kwargs["organization_id"] = organization_id

        request = ListUserAttributeKeysRequest(**request_kwargs)
        response = await self._grpc_client.get_stub(
            UserAttributesServiceStub
        ).ListUserAttributeKeys(request)
        response = cast("ListUserAttributeKeysResponse", response)

        keys = [UserAttributeKey._from_proto(key) for key in response.user_attribute_keys]
        return keys, response.next_page_token

    async def list_all_user_attribute_keys(
        self,
        *,
        query_filter: str | None = None,
        order_by: str | None = None,
        organization_id: str | None = None,
        include_archived: bool = False,
        max_results: int | None = None,
    ) -> list[UserAttributeKey]:
        """List all user attribute keys with optional filtering.

        Args:
            query_filter: A CEL filter string.
            order_by: How to order the retrieved keys.
            organization_id: Optional organization ID filter.
            include_archived: Whether to include archived keys.
            max_results: Maximum number of results to return.

        Returns:
            A list of all matching keys.
        """
        return await self._handle_pagination(
            self.list_user_attribute_keys,
            kwargs={
                "query_filter": query_filter,
                "organization_id": organization_id,
                "include_archived": include_archived,
            },
            order_by=order_by,
            max_results=max_results,
        )

    async def update_user_attribute_key(
        self, key: str | UserAttributeKey, update: UserAttributeKeyUpdate | dict
    ) -> UserAttributeKey:
        """Update a user attribute key.

        Args:
            key: The UserAttributeKey or key ID to update.
            update: Updates to apply to the key.

        Returns:
            The updated UserAttributeKey.
        """
        key_id = key._id_or_error if isinstance(key, UserAttributeKey) else key
        if isinstance(update, dict):
            update = UserAttributeKeyUpdate.model_validate(update)
        update.resource_id = key_id

        proto, mask = update.to_proto_with_mask()
        request = UpdateUserAttributeKeyRequest(user_attribute_key_id=key_id, update_mask=mask)
        if update.name is not None:
            request.name = update.name
        if update.description is not None:
            request.description = update.description

        response = await self._grpc_client.get_stub(
            UserAttributesServiceStub
        ).UpdateUserAttributeKey(request)
        grpc_key = cast("UpdateUserAttributeKeyResponse", response).user_attribute_key
        return UserAttributeKey._from_proto(grpc_key)

    async def archive_user_attribute_keys(self, key_ids: list[str]) -> None:
        """Archive user attribute keys.

        Args:
            key_ids: List of user attribute key IDs to archive.
        """
        request = ArchiveUserAttributeKeysRequest(user_attribute_key_ids=key_ids)
        await self._grpc_client.get_stub(UserAttributesServiceStub).ArchiveUserAttributeKeys(
            request
        )

    async def unarchive_user_attribute_keys(self, key_ids: list[str]) -> None:
        """Unarchive user attribute keys.

        Args:
            key_ids: List of user attribute key IDs to unarchive.
        """
        request = UnarchiveUserAttributeKeysRequest(user_attribute_key_ids=key_ids)
        await self._grpc_client.get_stub(UserAttributesServiceStub).UnarchiveUserAttributeKeys(
            request
        )

    # User Attribute Value methods

    async def create_user_attribute_value(
        self,
        key_id: str,
        user_id: str,
        string_value: str | None = None,
        number_value: float | None = None,
        boolean_value: bool | None = None,
    ) -> UserAttributeValue:
        """Create a new user attribute value.

        Args:
            key_id: The user attribute key ID.
            user_id: The user ID.
            string_value: String value (if applicable).
            number_value: Number value (if applicable).
            boolean_value: Boolean value (if applicable).

        Returns:
            The created UserAttributeValue.
        """
        request = CreateUserAttributeValueRequest(user_attribute_key_id=key_id, user_id=user_id)
        if string_value is not None:
            request.string_value = string_value
        elif number_value is not None:
            request.number_value = number_value
        elif boolean_value is not None:
            request.boolean_value = boolean_value

        response = await self._grpc_client.get_stub(
            UserAttributesServiceStub
        ).CreateUserAttributeValue(request)
        grpc_value = cast("CreateUserAttributeValueResponse", response).user_attribute_value
        return UserAttributeValue._from_proto(grpc_value)

    async def batch_create_user_attribute_value(
        self,
        key_id: str,
        user_ids: list[str],
        string_value: str | None = None,
        number_value: float | None = None,
        boolean_value: bool | None = None,
    ) -> list[UserAttributeValue]:
        """Create user attribute values for multiple users.

        Args:
            key_id: The user attribute key ID.
            user_ids: List of user IDs.
            string_value: String value (if applicable).
            number_value: Number value (if applicable).
            boolean_value: Boolean value (if applicable).

        Returns:
            List of created UserAttributeValues.
        """
        request = BatchCreateUserAttributeValueRequest(
            user_attribute_key_id=key_id, user_ids=user_ids
        )
        if string_value is not None:
            request.string_value = string_value
        elif number_value is not None:
            request.number_value = number_value
        elif boolean_value is not None:
            request.boolean_value = boolean_value

        response = await self._grpc_client.get_stub(
            UserAttributesServiceStub
        ).BatchCreateUserAttributeValue(request)
        grpc_values = cast("BatchCreateUserAttributeValueResponse", response).user_attribute_values
        return [UserAttributeValue._from_proto(val) for val in grpc_values]

    async def get_user_attribute_value(self, value_id: str) -> UserAttributeValue:
        """Get a user attribute value by ID.

        Args:
            value_id: The user attribute value ID.

        Returns:
            The UserAttributeValue.
        """
        request = GetUserAttributeValueRequest(user_attribute_value_id=value_id)
        response = await self._grpc_client.get_stub(
            UserAttributesServiceStub
        ).GetUserAttributeValue(request)
        grpc_value = cast("GetUserAttributeValueResponse", response).user_attribute_value
        return UserAttributeValue._from_proto(grpc_value)

    async def list_user_attribute_values(
        self,
        *,
        page_size: int | None = None,
        page_token: str | None = None,
        query_filter: str | None = None,
        order_by: str | None = None,
    ) -> tuple[list[UserAttributeValue], str]:
        """List user attribute values with optional filtering and pagination.

        Args:
            page_size: The maximum number of values to return.
            page_token: A page token for pagination.
            query_filter: A CEL filter string.
            order_by: How to order the retrieved values.

        Returns:
            A tuple of (values, next_page_token).
        """
        request_kwargs: dict[str, Any] = {}
        if page_size is not None:
            request_kwargs["page_size"] = page_size
        if page_token is not None:
            request_kwargs["page_token"] = page_token
        if query_filter is not None:
            request_kwargs["filter"] = query_filter
        if order_by is not None:
            request_kwargs["order_by"] = order_by

        request = ListUserAttributeValuesRequest(**request_kwargs)
        response = await self._grpc_client.get_stub(
            UserAttributesServiceStub
        ).ListUserAttributeValues(request)
        response = cast("ListUserAttributeValuesResponse", response)

        values = [UserAttributeValue._from_proto(val) for val in response.user_attribute_values]
        return values, response.next_page_token

    async def list_all_user_attribute_values(
        self,
        *,
        query_filter: str | None = None,
        order_by: str | None = None,
        max_results: int | None = None,
    ) -> list[UserAttributeValue]:
        """List all user attribute values with optional filtering.

        Args:
            query_filter: A CEL filter string.
            order_by: How to order the retrieved values.
            max_results: Maximum number of results to return.

        Returns:
            A list of all matching values.
        """
        return await self._handle_pagination(
            self.list_user_attribute_values,
            kwargs={"query_filter": query_filter},
            order_by=order_by,
            max_results=max_results,
        )

    async def list_user_attribute_key_values(
        self,
        key_id: str,
        *,
        page_size: int | None = None,
        page_token: str | None = None,
        query_filter: str | None = None,
        order_by: str | None = None,
        include_archived: bool = False,
    ) -> tuple[list[UserAttributeValue], str]:
        """List user attribute values for a given key with optional filtering and pagination.

        Args:
            key_id: The user attribute key ID.
            page_size: The maximum number of values to return.
            page_token: A page token for pagination.
            query_filter: A CEL filter string.
            order_by: How to order the retrieved values.
            include_archived: Whether to include archived values.

        Returns:
            A tuple of (values, next_page_token).
        """
        request_kwargs: dict[str, Any] = {
            "user_attribute_key_id": key_id,
            "include_archived": include_archived,
        }
        if page_size is not None:
            request_kwargs["page_size"] = page_size
        if page_token is not None:
            request_kwargs["page_token"] = page_token
        if query_filter is not None:
            request_kwargs["filter"] = query_filter
        if order_by is not None:
            request_kwargs["order_by"] = order_by

        request = ListUserAttributeKeyValuesRequest(**request_kwargs)
        response = await self._grpc_client.get_stub(
            UserAttributesServiceStub
        ).ListUserAttributeKeyValues(request)
        response = cast("ListUserAttributeKeyValuesResponse", response)

        values = [UserAttributeValue._from_proto(val) for val in response.user_attribute_values]
        return values, response.next_page_token

    async def list_all_user_attribute_key_values(
        self,
        key_id: str,
        *,
        query_filter: str | None = None,
        order_by: str | None = None,
        include_archived: bool = False,
        max_results: int | None = None,
    ) -> list[UserAttributeValue]:
        """List all user attribute values for a given key with optional filtering.

        Args:
            key_id: The user attribute key ID.
            query_filter: A CEL filter string.
            order_by: How to order the retrieved values.
            include_archived: Whether to include archived values.
            max_results: Maximum number of results to return.

        Returns:
            A list of all matching values.
        """
        return await self._handle_pagination(
            self.list_user_attribute_key_values,
            kwargs={
                "key_id": key_id,
                "query_filter": query_filter,
                "include_archived": include_archived,
            },
            order_by=order_by,
            max_results=max_results,
        )

    async def archive_user_attribute_values(self, value_ids: list[str]) -> None:
        """Archive user attribute values.

        Args:
            value_ids: List of user attribute value IDs to archive.
        """
        request = ArchiveUserAttributeValuesRequest(user_attribute_value_ids=value_ids)
        await self._grpc_client.get_stub(UserAttributesServiceStub).ArchiveUserAttributeValues(
            request
        )

    async def unarchive_user_attribute_values(self, value_ids: list[str]) -> None:
        """Unarchive user attribute values.

        Args:
            value_ids: List of user attribute value IDs to unarchive.
        """
        request = UnarchiveUserAttributeValuesRequest(user_attribute_value_ids=value_ids)
        await self._grpc_client.get_stub(UserAttributesServiceStub).UnarchiveUserAttributeValues(
            request
        )
